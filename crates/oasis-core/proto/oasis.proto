syntax = "proto3";

package oasis;

// ===== 强类型 ID 定义 =====
message AgentId {
  string value = 1;
}

message TaskId {
  string value = 1;
}

message BatchId {
  string value = 1;
}

// ===== 任务状态枚举 =====
enum TaskStateEnum {
  TASK_CREATED = 0;
  TASK_PENDING = 1;
  TASK_RUNNING = 2;
  TASK_SUCCESS = 3;
  TASK_FAILED = 4;
  TASK_TIMEOUT = 5;
  TASK_CANCELLED = 6;
}

// ===== Agent 状态枚举 =====
enum AgentStatusEnum {
  AGENT_ONLINE = 0;
  AGENT_OFFLINE = 1;
  AGENT_REMOVED = 2;
  AGENT_UNKNOWN = 3;
}

message SelectorExpression {
  string expression = 1;
}

message EmptyMsg {}


// 完整的任务信息
message TaskMsg {
  TaskId task_id = 1;
  BatchId batch_id = 2;
  AgentId agent_id = 3;

  // 执行定义
  string command = 4;
  repeated string args = 5;
  
  uint32 timeout_seconds = 6;
  
  // 状态信息
  TaskStateEnum state = 7;

  int64 created_at = 8;
  int64 updated_at = 9;
}

message BatchMsg {
  BatchId batch_id = 1;
  string command = 2;
  repeated string args = 3;
  uint32 timeout_seconds = 4;
  int64 created_at = 5;
}

// 任务执行结果 - 单个Agent执行结果
message TaskExecutionMsg {
  TaskId task_id = 1;
  AgentId agent_id = 2;
  
  // 执行结果
  TaskStateEnum state = 3;
  optional int32 exit_code = 4;
  string stdout = 5;
  string stderr = 6;
  
  // 时间信息
  int64 started_at = 7;
  optional int64 finished_at = 8;
  optional double duration_ms = 9;
}

// 批次请求消息 
message BatchRequestMsg {
  string command = 1;
  repeated string args = 2;
  SelectorExpression target = 3;
  uint32 timeout_seconds = 4;
}

// 提交批次请求
message SubmitBatchRequest {
  BatchRequestMsg batch_request = 1;
}

// 提交批次响应
message SubmitBatchResponse {
  BatchId batch_id = 1;
  int64 agent_nums = 2;
}

message GetBatchDetailsRequest {
  BatchId batch_id = 1;
  repeated TaskStateEnum states = 2;
}

message GetBatchDetailsResponse {
  repeated TaskExecutionMsg tasks = 1;
}

message GetTaskOutputRequest {
  TaskId task_id = 1;
}

message GetTaskOutputResponse {
  TaskExecutionMsg execution = 1;
}

// 列出任务请求
message ListBatchesRequest {
  uint32 limit = 1;
  repeated TaskStateEnum states = 2;  // 筛选状态
}

// 列出任务响应
message ListBatchesResponse {
  repeated BatchMsg batches = 1;
  uint32 total_count = 2;
  bool has_more = 3;
}

// 取消批次任务请求
message CancelBatchRequest {
  BatchId batch_id = 1;
}

// 取消批次任务响应
message CancelBatchResponse {
  bool success = 1;
}

message AgentStatus {
  AgentId agent_id = 1;
  bool online = 2;
}

message ListAgentsRequest {
  bool verbose = 1;
  SelectorExpression target = 2; 
  bool is_online = 3;
}

message AgentInfoMsg {
  AgentId agent_id = 1;
  AgentStatusEnum status = 2;
  map<string, string> info = 3;
  int64 last_heartbeat = 4;
  string version = 5;
  repeated string capabilities = 6;
}

message ListAgentsResponse {
  repeated AgentInfoMsg agents = 1;
}

message RemoveAgentRequest {
  AgentId agent_id = 1;
}

message RemoveAgentResponse {
  bool success = 1;
  string message = 2;
}

message SetInfoAgentRequest {
  AgentId agent_id = 1;
  map<string, string> info = 2;
}

message SetInfoAgentResponse {
  bool success = 1;
  string message = 2;
}

message FileSpecMsg {
  // 文件基本信息
  string source_path = 1;
  uint64 size = 2;
  string checksum = 3;
  string content_type = 4;
  int64 created_at = 5;
}

message FileConfigMsg {
  string source_path = 1;      // 源文件路径
  string destination_path = 2;
  uint64 revision = 3;
  string owner = 4;            // user:group 格式
  string mode = 5;             // 0644 格式
  SelectorExpression target = 6;   
}

message FileChunkMsg {
  string upload_id = 1;
  uint64 offset = 2;
  bytes data = 3;
}

message FileChunkResponse {
  uint64 received_bytes = 1;
  bool complete = 2;  // 是否完成上传
}

message CommitFileMsg {
  string upload_id = 1;
  bool verify_checksum = 2;  // 是否验证校验和
}

message FileUploadSession {
  string upload_id = 1;
  uint64 received_bytes = 2;  // 已接收字节（断点续传）
  uint64 chunk_size = 3;      // 建议的分片大小
  bool resume = 4;            // 是否为续传
}

message FileOperationResult {
  bool success = 1;
  string message = 2;
  uint64 revision = 3;
}

message FileApplyRequestMsg {
  FileConfigMsg config = 1;
}

// 文件版本信息
message FileVersionMsg {
  string name = 1;
  uint64 revision = 2;
  uint64 size = 3;
  string checksum = 4;
  int64 created_at = 5;
  bool is_current = 6;
}

// 文件历史信息
message FileHistoryMsg {
  string name = 1;
  repeated FileVersionMsg versions = 2;
  uint64 current_version = 3;
}

// 列出文件请求
message GetFileHistoryRequest {
  string source_path = 1; 
}

// 列出文件响应
message GetFileHistoryResponse {
  FileHistoryMsg file_history = 1;
}

// 回滚文件请求
message RollbackFileRequest {
  FileConfigMsg config = 1;
}

// ===== 灰度发布相关类型定义 =====

message RolloutId {
  string value = 1;
}

// 灰度发布状态枚举
enum RolloutStateEnum {
  ROLLOUT_CREATED = 0;
  ROLLOUT_RUNNING = 1;
  ROLLOUT_COMPLETED = 3;
  ROLLOUT_FAILED = 4;
  ROLLOUT_ROLLINGBACK = 5;
  ROLLOUT_ROLLBACKFAILED = 6;
  ROLLOUT_ROLLEDBACK = 7;
}

// 灰度发布策略
message RolloutStrategyMsg {
  oneof strategy {
    PercentageStrategy percentage = 1;
    CountStrategy count = 2;
  }
}

message PercentageStrategy {
  repeated uint32 stages = 1; // [10, 30, 60, 100]
}

message CountStrategy {
  repeated uint32 stages = 1; // [2, 5, 10, 0]
}



// 灰度发布任务类型
message RolloutTaskTypeMsg {
  oneof task_type {
    CommandTask command = 1;
    FileDeploymentTask file_deployment = 2;
  }
}

message CommandTask {
  string command = 1;
  repeated string args = 2;
  uint32 timeout_seconds = 3;
}

message FileDeploymentTask {
  FileConfigMsg config = 1;
}

// 灰度发布配置
message RolloutConfigMsg {
  RolloutId rollout_id = 1;
  string name = 2;
  SelectorExpression target = 3;
  RolloutStrategyMsg strategy = 4;
  RolloutTaskTypeMsg task_type = 5;
  bool auto_advance = 6;
  uint32 advance_interval_seconds = 7;
  int64 created_at = 8;
}

// 灰度发布阶段状态
message RolloutStageStatusMsg {
  string stage_name = 1;
  repeated AgentId target_agents = 2;
  optional BatchId batch_id = 3;
  uint32 started_count = 4;
  uint32 completed_count = 5;
  uint32 failed_count = 6;
  optional int64 started_at = 7;
  optional int64 completed_at = 8;
  repeated TaskExecutionMsg failed_executions = 9;
}

// 灰度发布状态
message RolloutStatusMsg {
  RolloutConfigMsg config = 1;
  RolloutStateEnum state = 2;
  uint64 current_stage_idx = 3;
  repeated RolloutStageStatusMsg stages = 4;
  repeated AgentId all_target_agents = 5;
  int64 updated_at = 6;
  optional string error_message = 7;
  optional string current_action = 8; // 当前动作（例如回滚命令）
}

// ===== 请求/响应消息 =====

// 创建灰度发布请求
message CreateRolloutRequest {
  string name = 1;
  SelectorExpression target = 2;
  RolloutStrategyMsg strategy = 3;
  RolloutTaskTypeMsg task_type = 4;
  bool auto_advance = 5;
  uint32 advance_interval_seconds = 6;
}

// 创建灰度发布响应
message CreateRolloutResponse {
  RolloutId rollout_id = 1;
  int64 total_agents = 2;
  bool success = 3;
  string message = 4;
}

// 获取灰度发布状态请求
message GetRolloutStatusRequest {
  RolloutId rollout_id = 1;
}

// 获取灰度发布状态响应
message GetRolloutStatusResponse {
  RolloutStatusMsg status = 1;
}

// 列出灰度发布请求
message ListRolloutsRequest {
  uint32 limit = 1;
  repeated RolloutStateEnum states = 2;
}

// 列出灰度发布响应
message ListRolloutsResponse {
  repeated RolloutStatusMsg rollouts = 1;
  uint32 total_count = 2;
  bool has_more = 3;
}

// 推进灰度发布请求
message AdvanceRolloutRequest {
  RolloutId rollout_id = 1;
}

// 推进灰度发布响应
message AdvanceRolloutResponse {
  bool success = 1;
  string message = 2;
  optional uint32 next_stage = 3;
}

// 回滚灰度发布请求
message RollbackRolloutRequest {
  RolloutId rollout_id = 1;
  optional string rollback_command = 2; // 回滚命令（可选）
}

// 回滚灰度发布响应
message RollbackRolloutResponse {
  bool success = 1;
  string message = 2;
}

// ===== 主服务定义 =====
service OasisService {
  // 任务管理
  rpc SubmitBatch(SubmitBatchRequest) returns (SubmitBatchResponse);
  rpc GetBatchDetails(GetBatchDetailsRequest) returns (GetBatchDetailsResponse);
  rpc GetTaskOutput(GetTaskOutputRequest) returns (GetTaskOutputResponse);
  rpc ListBatches(ListBatchesRequest) returns (ListBatchesResponse);
  rpc CancelBatch(CancelBatchRequest) returns (CancelBatchResponse);
  
  // Agent管理
  rpc ListAgents(ListAgentsRequest) returns (ListAgentsResponse);
  rpc RemoveAgent(RemoveAgentRequest) returns (RemoveAgentResponse);
  rpc SetInfoAgent(SetInfoAgentRequest) returns (SetInfoAgentResponse);
  
  // 文件管理
  rpc BeginFileUpload(FileSpecMsg) returns (FileUploadSession);
  rpc UploadFileChunk(FileChunkMsg) returns (FileChunkResponse);
  rpc CommitFileUpload(CommitFileMsg) returns (FileOperationResult);
  rpc ApplyFile(FileApplyRequestMsg) returns (FileOperationResult);
  rpc GetFileHistory(GetFileHistoryRequest) returns (GetFileHistoryResponse);
  rpc RollbackFile(RollbackFileRequest) returns (FileOperationResult);
  rpc ClearFiles(EmptyMsg) returns (FileOperationResult);

  // 灰度发布管理
  rpc CreateRollout(CreateRolloutRequest) returns (CreateRolloutResponse);
  rpc GetRolloutStatus(GetRolloutStatusRequest) returns (GetRolloutStatusResponse);
  rpc ListRollouts(ListRolloutsRequest) returns (ListRolloutsResponse);
  rpc AdvanceRollout(AdvanceRolloutRequest) returns (AdvanceRolloutResponse);
  rpc RollbackRollout(RollbackRolloutRequest) returns (RollbackRolloutResponse);
}

